# Use the official R Shiny image
FROM rocker/shiny:4.3.0

# Install system dependencies
RUN apt-get update && apt-get install -y \
    libcurl4-gnutls-dev \
    libssl-dev \
    libxml2-dev \
    libpng-dev \
    libjpeg-dev \
    && rm -rf /var/lib/apt/lists/*

# Set working directory
WORKDIR /srv/shiny-server

# Copy renv files first for dependency caching
COPY renv.lock renv.lock
COPY .Rprofile .Rprofile

# Install renv and restore packages
RUN R -e "install.packages('renv', repos = c(CRAN = 'https://cloud.r-project.org'))"
RUN R -e "renv::consent(provided = TRUE)"
RUN R -e "renv::restore()"

# Copy application files
COPY . .

# Make sure the app is executable
RUN chmod -R 755 /srv/shiny-server

# Expose port
EXPOSE 3838

# Run the application
CMD ["R", "-e", "shiny::runApp('/srv/shiny-server', host = '0.0.0.0', port = 3838)"]